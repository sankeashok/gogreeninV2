name: Sync Google Sheets to Website

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  sync-data:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          ref: gh-pages
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Fetch data from Google Sheets
        env:
          SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
          API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        run: |
          curl -s "https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/Sheet1?key=${API_KEY}" > sheet-data.json
      
      - name: Sync Google Sheets (replace mode)
        run: |
          node << 'EOF'
          const fs = require('fs');
          const sheetData = JSON.parse(fs.readFileSync('sheet-data.json', 'utf8'));
          
          let existingData = {};
          try {
            const existingFile = fs.readFileSync('v3/assets/js/yearData.js', 'utf8');
            const match = existingFile.match(/window\.yearData\s*=\s*({[\s\S]*});/);
            if (match) existingData = JSON.parse(match[1]);
          } catch (e) {}
          
          // Clear monthlyData for years in Google Sheets
          const sheetYears = new Set();
          if (sheetData.values && sheetData.values.length > 1) {
            sheetData.values.slice(1).forEach(row => {
              if (row[0]) sheetYears.add(row[0].toString());
            });
            
            sheetYears.forEach(year => {
              if (existingData[year]) existingData[year].monthlyData = [];
            });
            
            // Add fresh data
            sheetData.values.slice(1).forEach(row => {
              const [year, month, rideName, cyclists, videoUrl, photoUrls] = row;
              if (!year || !month) return;
              
              if (!existingData[year]) {
                existingData[year] = {
                  title: `${year} Journey`,
                  description: `Events from ${year}`,
                  events: [],
                  monthlyData: []
                };
              }
              
              if (!existingData[year].monthlyData) existingData[year].monthlyData = [];
              
              let monthData = existingData[year].monthlyData.find(m => m.month === month);
              if (!monthData) {
                monthData = { month, rides: 0, cyclists: 0, events: [] };
                existingData[year].monthlyData.push(monthData);
              }
              
              monthData.rides++;
              monthData.cyclists += parseInt(cyclists || 0);
              monthData.events.push({
                name: rideName,
                url: videoUrl || '',
                photos: photoUrls ? photoUrls.split(',').map(u => u.trim()) : [],
                videos: []
              });
            });
          }
          
          const jsContent = `// Auto-synced from Google Sheets\n// Last updated: ${new Date().toISOString()}\nwindow.yearData = ${JSON.stringify(existingData, null, 2)};`;
          fs.writeFileSync('v3/assets/js/yearData.js', jsContent);
          console.log('âœ… Synced successfully');
          EOF
      
      - name: Check for changes
        id: check_changes
        run: |
          git diff --quiet v3/assets/js/yearData.js || echo "changed=true" >> $GITHUB_OUTPUT
      
      - name: Commit and push if changed
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          git config user.name "Ashok Sanke"
          git config user.email "sankeashok@gmail.com"
          git add v3/assets/js/yearData.js
          git commit -m "Auto-sync: Update ride data from Google Sheets"
          git push
      
      - name: Cleanup
        run: rm -f sheet-data.json
