name: Sync Google Sheets to Website

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  sync-data:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          ref: gh-pages
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Fetch data from Google Sheets
        env:
          SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
          API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        run: |
          curl -s "https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/Sheet1?key=${API_KEY}" > sheet-data.json
      
      - name: Sync and deduplicate
        run: |
          node << 'EOF'
          const fs = require('fs');
          const sheetData = JSON.parse(fs.readFileSync('sheet-data.json', 'utf8'));
          
          // Load existing yearData for historical years
          let existingData = {};
          try {
            const existingFile = fs.readFileSync('v3/assets/js/yearData.js', 'utf8');
            const match = existingFile.match(/window\.yearData\s*=\s*({[\s\S]*});/);
            if (match) existingData = JSON.parse(match[1]);
          } catch (e) {
            console.log('Starting fresh');
          }
          
          // Build fresh data from Google Sheets
          const sheetYearsData = {};
          
          if (sheetData.values && sheetData.values.length > 1) {
            sheetData.values.slice(1).forEach(row => {
              const [year, month, rideName, cyclists, videoUrl, photoUrls] = row;
              if (!year || !month || !rideName) return;
              
              if (!sheetYearsData[year]) {
                sheetYearsData[year] = {};
              }
              
              if (!sheetYearsData[year][month]) {
                sheetYearsData[year][month] = [];
              }
              
              // Add ride (duplicates will be removed later)
              sheetYearsData[year][month].push({
                name: rideName,
                url: videoUrl || '',
                photos: photoUrls ? photoUrls.split(',').map(u => u.trim()) : [],
                videos: [],
                cyclists: parseInt(cyclists || 0)
              });
            });
          }
          
          // Replace monthlyData for years in Google Sheets
          Object.keys(sheetYearsData).forEach(year => {
            if (!existingData[year]) {
              existingData[year] = {
                title: `${year} Journey`,
                description: `Events from ${year}`,
                events: [],
                monthlyData: []
              };
            }
            
            // Clear and rebuild monthlyData
            existingData[year].monthlyData = [];
            
            Object.keys(sheetYearsData[year]).forEach(month => {
              const rides = sheetYearsData[year][month];
              
              // Remove duplicates by name
              const uniqueRides = [];
              const seen = new Set();
              rides.forEach(ride => {
                if (!seen.has(ride.name)) {
                  seen.add(ride.name);
                  uniqueRides.push(ride);
                }
              });
              
              // Sort by ride number (descending)
              uniqueRides.sort((a, b) => {
                const getRideNum = (name) => {
                  const match = name.match(/Ride\s+(\d+)/i);
                  return match ? parseInt(match[1]) : 0;
                };
                return getRideNum(b.name) - getRideNum(a.name);
              });
              
              existingData[year].monthlyData.push({
                month: month,
                rides: uniqueRides.length,
                cyclists: uniqueRides.reduce((sum, r) => sum + r.cyclists, 0),
                events: uniqueRides
              });
            });
          });
          
          const jsContent = `// Auto-synced from Google Sheets\n// Last updated: ${new Date().toISOString()}\nwindow.yearData = ${JSON.stringify(existingData, null, 2)};`;
          fs.writeFileSync('v3/assets/js/yearData.js', jsContent);
          console.log('âœ… Synced successfully - no duplicates');
          EOF
      
      - name: Check for changes
        id: check_changes
        run: |
          git diff --quiet v3/assets/js/yearData.js || echo "changed=true" >> $GITHUB_OUTPUT
      
      - name: Commit and push if changed
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          git config user.name "Ashok Sanke"
          git config user.email "sankeashok@gmail.com"
          git add v3/assets/js/yearData.js
          git commit -m "Auto-sync: Update ride data from Google Sheets"
          git push
      
      - name: Cleanup
        run: rm -f sheet-data.json
